name: .NET

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Check for version
      run: |
        if [[ "${{ github.event.head_commit.message }}" =~ ([0-9]\.){2}[0-9]$ ]]; then
          echo "Proceeding with the workflow."
        else
          echo "Not a release commit. Exiting workflow."
          exit 78
        fi
    - uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x
    - name: Build
      run: dotnet build
    - name: Get package info
      id: package-info
      run: |
        # Extract values from manifest.json
        NAME=$(jq -r '.name' manifest.json)
        VERSION_NUMBER=$(jq -r '.version_number' manifest.json)
        DESCRIPTION=$(jq -r '.description' manifest.json)
        WEBSITE_URL=$(jq -r '.website_url' manifest.json)
        DEPENDENCIES=$(jq -r '.dependencies | join(" ")' manifest.json)
        # Set output variables for later use
        echo "::set-output name=name::$NAME"
        echo "::set-output name=version_number::$VERSION_NUMBER"
        echo "::set-output name=description::$DESCRIPTION"
        echo "::set-output name=website_url::$WEBSITE_URL"
        echo "::set-output name=dependencies::$DEPENDENCIES"
    - name: Display package info
      run: |
        echo "Name: ${{ steps.package-info.outputs.name }}"
        echo "Version Number: ${{ steps.package-info.outputs.version_number }}"
        echo "Description: ${{ steps.package-info.outputs.description }}"
        echo "Website URL: ${{ steps.package-info.outputs.website_url }}"
        echo "Dependencies: ${{ steps.package-info.outputs.dependencies }}"
    - name: Zip files
      run: |
        ls -r BetterLadders/bin
        zip -r "${{ steps.package-info.outputs.name }} ${{ steps.package-info.outputs.version_number }}.zip" "manifest.json" "icon.png" "README.md" "CHANGELOG.md" "BetterLadders/bin/Debug/net*/*.dll"
    - name: Upload to Thunderstore
      uses: GreenTF/upload-thunderstore-package@v4.3
      with:
        namespace: e3s1 # the thunderstore 'team' to publish under
        description: ${{ steps.package-info.outputs.description }}
        token: ${{ secrets.THUNDERSTOREAPIKEY }}
        name: ${{ steps.package-info.outputs.name }}
        version: ${{ steps.package-info.outputs.version_number }}
        community: lethal-company
        website: ${{ steps.package-info.outputs.website_url }}
        deps: ${{ steps.package-info.outputs.dependencies }}
        dev: true
        file: BetterLadders ${{ steps.extract-info.outputs.version_number }}.zip
        categories: |
          bepinex
          mods
          clientside
          serverside
          misc
