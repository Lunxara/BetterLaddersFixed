name: Build and Publish

on:
  release:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x
    - name: Build
      run: dotnet build
    - name: Get Release Info
      run: |
        echo "NAME=$(jq -r '.name' manifest.json)" >> $GITHUB_ENV
        echo "VERSION_NUMBER=$(jq -r '.version_number' manifest.json)" >> $GITHUB_ENV
        echo "DESCRIPTION=$(jq -r '.description' manifest.json)" >> $GITHUB_ENV
        echo "DEPENDENCIES=$(jq -r '.dependencies | join(" ")' manifest.json)" >> $GITHUB_ENV
        echo "ZIP_NAME=${{ env.NAME }}-${{ env.VERSION_NUMBER }}.zip" >> $GITHUB_ENV
        echo "DLL_NAME=${{ env.NAME }}.dll" >> $GITHUB_ENV
    - name: Create Thunderstore Package
      run: |
        zip -j ${{ env.ZIP_NAME }} "manifest.json" "icon.png" "README.md" "CHANGELOG.md" "BetterLadders/bin/Debug/netstandard2.1/${{ env.DLL_NAME }}"
    - name: Attach Binary to Release
      run: |
        curl -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          -H "Content-Type: application/octet-stream" \
          "https://uploads.github.com/repos/${{ github.actor }}/${{ github.repository }}/releases/${{ github.event.release.id }}/assets?name=${{ env.DLL_NAME }}" \
          --data-binary "@${{ env.DLL_NAME }}"
    - name: Upload to Thunderstore
      uses: GreenTF/upload-thunderstore-package@v4.3
      with:
        namespace: e3s1
        description: ${{ env.DESCRIPTION }}
        token: ${{ secrets.TS_API_KEY }}
        name: ${{ env.NAME }}
        version: ${{ env.VERSION_NUMBER }}
        community: lethal-company
        repo: thunderstore.io
        deps: ${{ env.DEPENDENCIES }}
        file: ${{ env.ZIP_NAME }}
        categories: |
          bepinex
          mods
          clientside
          serverside
          misc
